#!/usr/bin/env php
<?php

declare(strict_types=1);

use Filacheck\Fixer\CodeFixer;
use Filacheck\Reporting\StandaloneReporter;
use Filacheck\Rules\DeprecatedActionFormRule;
use Filacheck\Rules\DeprecatedEmptyLabelRule;
use Filacheck\Rules\DeprecatedFilterFormRule;
use Filacheck\Rules\DeprecatedFormsSetRule;
use Filacheck\Rules\DeprecatedImageColumnSizeRule;
use Filacheck\Rules\DeprecatedMutateFormDataUsingRule;
use Filacheck\Rules\DeprecatedPlaceholderRule;
use Filacheck\Rules\DeprecatedReactiveRule;
use Filacheck\Scanner\ResourceScanner;
use Filacheck\Support\RuleRegistry;
use Symfony\Component\Console\Output\ConsoleOutput;

// Autoload handling for different installation contexts
$autoloadPaths = [
    __DIR__.'/../vendor/autoload.php',           // Package development
    __DIR__.'/../../../autoload.php',            // Installed as dependency
    __DIR__.'/../../../../vendor/autoload.php',  // Laravel project context
];

$autoloaded = false;
foreach ($autoloadPaths as $autoloadPath) {
    if (file_exists($autoloadPath)) {
        require $autoloadPath;
        $autoloaded = true;
        break;
    }
}

if (! $autoloaded) {
    fwrite(STDERR, "Error: Could not find autoloader. Run 'composer install' first.\n");
    exit(1);
}

$output = new ConsoleOutput();

// Parse arguments
$args = array_slice($argv, 1);
$path = null;
$verbose = false;
$fix = false;
$backup = false;
$showHelp = false;
$showVersion = false;

foreach ($args as $arg) {
    if ($arg === '--help' || $arg === '-h') {
        $showHelp = true;
    } elseif ($arg === '--version' || $arg === '-V') {
        $showVersion = true;
    } elseif ($arg === '--detailed' || $arg === '-d') {
        $verbose = true;
    } elseif ($arg === '--fix') {
        $fix = true;
    } elseif ($arg === '--backup') {
        $backup = true;
    } elseif (! str_starts_with($arg, '-')) {
        $path = $arg;
    }
}

$version = fn () => trim(shell_exec('git describe --tags --abbrev=0 2>/dev/null') ?? '') ?: 'dev';

if ($showVersion) {
    $output->writeln('FilaCheck <info>'.$version().'</info>');
    exit(0);
}

if ($showHelp) {
    $output->writeln('FilaCheck <info>'.$version().'</info>');
    $output->writeln('');
    $output->writeln('<fg=yellow>Usage:</>');
    $output->writeln('  filacheck [path] [options]');
    $output->writeln('');
    $output->writeln('<fg=yellow>Arguments:</>');
    $output->writeln('  path                  Directory to scan (default: app/Filament)');
    $output->writeln('');
    $output->writeln('<fg=yellow>Options:</>');
    $output->writeln('  -d, --detailed        Show detailed output with rule categories');
    $output->writeln('  --fix                 Automatically fix issues where possible');
    $output->writeln('  --backup              Create backup files when fixing (requires --fix)');
    $output->writeln('  -h, --help            Display this help message');
    $output->writeln('  -V, --version         Display version');
    $output->writeln('');
    $output->writeln('<fg=yellow>Examples:</>');
    $output->writeln('  filacheck                           Scan app/Filament directory');
    $output->writeln('  filacheck app/Filament/Resources    Scan specific directory');
    $output->writeln('  filacheck --detailed                Show detailed report');
    $output->writeln('  filacheck --fix                     Auto-fix issues');
    $output->writeln('  filacheck --fix --backup            Auto-fix with backups');
    exit(0);
}

// Default path
if ($path === null) {
    $path = getcwd().'/app/Filament';
}

// Make relative paths absolute
if (! str_starts_with($path, '/')) {
    $path = getcwd().'/'.$path;
}

if (! is_dir($path)) {
    $output->writeln("<fg=red>Error:</> Directory not found: {$path}");
    exit(1);
}

$output->writeln("Scanning: <fg=gray>{$path}</>");
$output->writeln('');

$scanner = new ResourceScanner();

$registry = new RuleRegistry();

// Free rules
$registry->register([
    DeprecatedReactiveRule::class,
    DeprecatedActionFormRule::class,
    DeprecatedFilterFormRule::class,
    DeprecatedPlaceholderRule::class,
    DeprecatedMutateFormDataUsingRule::class,
    DeprecatedEmptyLabelRule::class,
    DeprecatedFormsSetRule::class,
    DeprecatedImageColumnSizeRule::class,
]);

// Pro rules (auto-detected if installed)
$proProvider = 'FilacheckPro\\FilacheckProServiceProvider';
if (class_exists($proProvider)) {
    $registry->register($proProvider::rules());
}

foreach ($registry->all() as $rule) {
    $scanner->addRule($rule);
}

$violations = $scanner->scan($path);

$reporter = new StandaloneReporter($output, $verbose);

if ($fix && count($violations) > 0) {
    $fixer = new CodeFixer();
    $fixResults = $fixer->fix($violations, $backup);

    $reporter->reportWithFixes($scanner->getRules(), $violations, $fixResults);

    exit($fixResults['skipped'] > 0 ? 1 : 0);
}

$reporter->report($scanner->getRules(), $violations);

exit(count($violations) > 0 ? 1 : 0);
